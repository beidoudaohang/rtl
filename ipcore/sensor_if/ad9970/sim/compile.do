##-------------------------------------------------------------------------------------------------
##
##  -- 模块描述     : compile.do完成源代码编译的任务，主要分为3个阶段
##              1)  : 准备阶段，先把define.do跑一边，检查是否是后仿真，此处不能修改
##
##              2)  : 根据被测试模块，定义需要仿真的源代码
##
##              3)  : 编译文件，文件共有4中类型，包括(1)源代码、(2)仿真模型、(3)testbench测试代码、(4)共用的测试代码
##						用户需要修改这部分
##
##-------------------------------------------------------------------------------------------------

##	===============================================================================================
##	ref ***准备工作，不能修改***
##	===============================================================================================
##	-------------------------------------------------------------------------------------
##	首先先把define.do 跑一遍，防止修改了define之后，造成错误
##	-------------------------------------------------------------------------------------
do define.do
echo	"compile start ******"

##	-------------------------------------------------------------------------------------
##	如果定义了后仿真，首先把netgen目录下清空，然后再把工程目录下的netgen目录复制过来
##	-------------------------------------------------------------------------------------
if {$SIM_MODE == "back" } {
	file delete -force netgen
	file copy ../prj/netgen	../sim
}

##	===============================================================================================
##	ref ***定义需要仿真的模块***
##	===============================================================================================
##	-------------------------------------------------------------------------------------
##	编译
##	1.如果定义了后仿真，则必须要用仿真par工具生成的.v文件
##	2.如果不是后仿真，则需要根据参数，选择需要的源文件
##	-------------------------------------------------------------------------------------
set	global_para		1
set	ccd				0
set	deser			0
set	sel				0
set	cut				0
set	ad9970			0
set	ccd_sharp		0

if {$SIM_MODE == "back" } {
	set	mt9p031			1
} else {
	if {$TB_MODULE == "ccd" } {
		set	ccd			1
	} elseif {$TB_MODULE == "ccd_deser" } {
		set	ccd			1
		set	deser		1
		set	ad9970		1
		set	ccd_sharp	1
	} elseif {$TB_MODULE == "ccd_deser_cut" } {
		set	ccd			1
		set	deser		1
		set	sel			1
		set	cut			1
		set	ad9970		1
		set	ccd_sharp	1
	}
}


##	===============================================================================================
##	ref ***开始编译***
##	===============================================================================================
##	-------------------------------------------------------------------------------------
##	常用的compile的语法
##	1.+incdir+ 包含头文件的路径
##	2.+define+MACRO[=NAME]	宏定义
##	-------------------------------------------------------------------------------------
#vlog	$env(XILINX)/verilog/src/glbl.v
#vlog	../testbench/tb_bram.v
#vlog	+incdir+../src	+incdir+../testbench	+define+SIMULATION	../src/*.v
#vlog	+incdir+../testbench +define+x1Gb +define+sg187E +define+x16 ../testbench/ddr3_model_c3.v

##	-------------------------------------------------------------------------------------
##	xilinx的很多ip需要glbl文件才能仿真
##	-------------------------------------------------------------------------------------
vlog	$env(XILINX)/verilog/src/glbl.v

##	-------------------------------------------------------------------------------------
##	根据不同的DUT，compile不同的文件
##	-------------------------------------------------------------------------------------
##	-------------------------------------------------------------------------------------
##	ref 1.编译源代码
##	-------------------------------------------------------------------------------------
##	-------------------------------------------------------------------------------------
##	ccd 模块
##	-------------------------------------------------------------------------------------
if { $ccd == 1 } {
	vlog	+incdir+../src/mv_ccd	../src/mv_ccd/*.v
}

##	-------------------------------------------------------------------------------------
##	deser 模块
##	-------------------------------------------------------------------------------------
if { $deser == 1 } {
	vlog	+incdir+../src/mv_ccd	+incdir+../src/data_channel/deserializer_new	../src/data_channel/deserializer_new/*.v
}

##	-------------------------------------------------------------------------------------
##	sel 模块
##	-------------------------------------------------------------------------------------
if { $deser == 1 } {
	vlog	+incdir+../src	../src/data_channel/signal_sel.v
}

##	-------------------------------------------------------------------------------------
##	cut 模块
##	-------------------------------------------------------------------------------------
if { $deser == 1 } {
	vlog	+incdir+../src	../src/data_channel/image_cut/*.v
}

##	-------------------------------------------------------------------------------------
##	编译后仿真生成的时序文件
##	-------------------------------------------------------------------------------------
if {$SIM_MODE == "back" } {
	vlog	"netgen/par/top_frame_buffer_timesim.v"
}

##	-------------------------------------------------------------------------------------
##	ref 2.编译仿真模型
##	-------------------------------------------------------------------------------------
##	-------------------------------------------------------------------------------------
##	Sensor mt9p031 仿真模型
##	-------------------------------------------------------------------------------------
if { $ccd_sharp == 1 } {
	vlog	+define+TESTCASE=$TESTCASE	../testbench/ccd_sharp/*.v
}
##	-------------------------------------------------------------------------------------
##	AD9970 仿真模型
##	-------------------------------------------------------------------------------------
if { $ad9970 == 1 } {
	vlog	+define+TESTCASE=$TESTCASE	../testbench/ad9970/*.v
	vlog	+define+TESTCASE=$TESTCASE	../testbench/ad9970/spartan6_dcm/*.v
	vlog	+define+TESTCASE=$TESTCASE	../testbench/ad9970/xo2_pll/*.v
}

##	-------------------------------------------------------------------------------------
##	ref 3.编译测试代码
##	-------------------------------------------------------------------------------------
vlog	+incdir+../src/mv_ccd	+incdir+../src/data_channel/deserializer_new	+incdir+../src	+define+TESTCASE=$TESTCASE	../testbench/tb_$TB_MODULE/*.v

##	-------------------------------------------------------------------------------------
##	ref 4.编译全局测试文件
##	-------------------------------------------------------------------------------------
if { $global_para == 1 } {
	vlog	+incdir+../src/mv_ccd	+incdir+../src/data_channel/deserializer_new	+incdir+../src	+define+TESTCASE=$TESTCASE	../testbench/global/*.v
}

