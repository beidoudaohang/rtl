##-------------------------------------------------------------------------------------------------
##
##  -- 模块描述     : compile.do完成源代码编译的任务，主要分为3个阶段
##              1)  : 准备阶段，先把define.do跑一边，检查是否是后仿真，此处不能修改
##
##              2)  : 根据被测试模块，定义需要仿真的源代码
##
##              3)  : 编译文件，文件共有4中类型，包括(1)源代码、(2)仿真模型、(3)testbench测试代码、(4)共用的测试代码
##						用户需要修改这部分
##
##-------------------------------------------------------------------------------------------------

##	===============================================================================================
##	ref ***准备工作，不能修改***
##	===============================================================================================
##	-------------------------------------------------------------------------------------
##	首先先把define.do 跑一遍，防止修改了define之后，造成错误
##	-------------------------------------------------------------------------------------
do define.do
echo	"compile start ******"

##	-------------------------------------------------------------------------------------
##	如果定义了后仿真，首先把netgen目录下清空，然后再把工程目录下的netgen目录复制过来
##	-------------------------------------------------------------------------------------
if {$SIM_MODE == "back" } {
	file delete -force netgen
	file copy ../prj/netgen	../sim
}
file delete -force trigger_cmd_ram_w32d32.mif
file copy ../src/ctrl_channel/i2c_top/trigger_cmd_ram/trigger_cmd_ram_w32d32.mif 	../sim

##	===============================================================================================
##	ref ***定义需要仿真的模块***
##	===============================================================================================
##	-------------------------------------------------------------------------------------
##	编译
##	1.如果定义了后仿真，则必须要用仿真par工具生成的.v文件
##	2.如果不是后仿真，则需要根据参数，选择需要的源文件
##	-------------------------------------------------------------------------------------
set	global_para		1

set	clock_reset		0
set	ctrl_channel	0
set	io_channel		0

set	data_channel	0
set	hispi_if_new	0
set	data_fix		0
set	u3v_format		0
set	frame_buffer	0
set	u3_interface	0

set	top				0

set	spi_master		0
set	ddr3			0
set	hispi			0
set	gpif_3014		0




if {$SIM_MODE == "back" } {
	if {$TB_MODULE == "sync_buffer" } {
		set	mt9p031			1
	} elseif {$TB_MODULE == "pulse_filter" } {
		set	spi_master		0
	} else {
		set	ddr3			0
	}
} else {
	if {$TB_MODULE == "mer" } {
		set	clock_reset		1
		set	ctrl_channel	1
		set	io_channel		1

		set	data_channel	1
		set	data_fix		1
		set	u3v_format		1
		set	frame_buffer	1
		set	u3_interface	1

		set	top				1

		set	spi_master		1
		set	ddr3			1
		set	hispi			1
		set	gpif_3014		1
	} elseif {$TB_MODULE == "deser_hispi" } {

		set	data_channel	1
		set	hispi			1
		set	clock_reset		1

	} elseif {$TB_MODULE == "deser_word_align" } {
		set	hispi_if_new	1
		set	hispi			1
	} elseif {$TB_MODULE == "deser_hispi_if_new" } {
		set	hispi_if_new	1
		set	hispi			1
	} elseif {$TB_MODULE == "clock_reset" } {
		set	clock_reset		1
	} else {
		set	ctrl_channel	1
	}
}


##	===============================================================================================
##	ref ***开始编译***
##	===============================================================================================
##	-------------------------------------------------------------------------------------
##	常用的compile的语法
##	1.+incdir+ 包含头文件的路径
##	2.+define+MACRO[=NAME]	宏定义
##	-------------------------------------------------------------------------------------
#vlog	$env(XILINX)/verilog/src/glbl.v
#vlog	../testbench/tb_bram.v
#vlog	+incdir+../src	+incdir+../testbench	+define+SIMULATION	../src/*.v
#vlog	+incdir+../testbench +define+x1Gb +define+sg187E +define+x16 ../testbench/ddr3_model_c3.v

##	-------------------------------------------------------------------------------------
##	xilinx的很多ip需要glbl文件才能仿真
##	-------------------------------------------------------------------------------------
vlog	$env(XILINX)/verilog/src/glbl.v

##	-------------------------------------------------------------------------------------
##	根据不同的DUT，compile不同的文件
##	-------------------------------------------------------------------------------------
##	-------------------------------------------------------------------------------------
##	ref 1.编译源代码
##	-------------------------------------------------------------------------------------
##	-------------------------------------------------------------------------------------
##	clock_reset 模块
##	-------------------------------------------------------------------------------------
if { $clock_reset == 1 } {
	vlog	../src/clock_reset/*.v
}

##	-------------------------------------------------------------------------------------
##	ctrl_channel 模块
##	-------------------------------------------------------------------------------------
if { $ctrl_channel == 1 } {
	##	-------------------------------------------------------------------------------------
	##	控制通道通用模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/ctrl_channel/*.v

	##	-------------------------------------------------------------------------------------
	##	控制通道通用模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/ctrl_channel/i2c_top/*.v
	vlog	../src/ctrl_channel/i2c_top/continuous_cmd_fifo/*.v
	vlog	../src/ctrl_channel/i2c_top/i2c_master_wb_top/*.v
	vlog	+incdir+../src/ctrl_channel/i2c_top/trigger_cmd_ram		../src/ctrl_channel/i2c_top/trigger_cmd_ram/*.v
}

##	-------------------------------------------------------------------------------------
##	io_channel 模块
##	-------------------------------------------------------------------------------------
if { $io_channel == 1 } {
	vlog	../src/io_channel/*.v
	vlog	../src/io_channel/test/*.v
}

##	-------------------------------------------------------------------------------------
##	data_channel 模块
##	-------------------------------------------------------------------------------------
if { $data_channel == 1 } {

	##	-------------------------------------------------------------------------------------
	##	hispi_if_new 模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/data_channel/hispi_if_quick/*.v

	##	-------------------------------------------------------------------------------------
	##	deser 模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/data_channel/deser/*.v

	##	-------------------------------------------------------------------------------------
	##	pll_reset 模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/data_channel/pll_reset.v

	##	-------------------------------------------------------------------------------------
	##	sync_bufferr 模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/data_channel/sync_buffer/*.v
	vlog	../src/data_channel/sync_buffer/fifo_bram/*.v

	##	-------------------------------------------------------------------------------------
	##	raw_wb 模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/data_channel/raw_wb/*.v
	vlog	../src/data_channel/raw_wb/wb_mult/wb_mult_a17b17p34.v

	##	-------------------------------------------------------------------------------------
	##	grey_statistics 模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/data_channel/grey_statistics/*.v
	vlog	../src/data_channel/*.v

	##	-------------------------------------------------------------------------------------
	##	binary_counter 模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/data_channel/binary_counter/*.v

}

##	-------------------------------------------------------------------------------------
##	data_fix 模块
##	-------------------------------------------------------------------------------------
if { $data_fix == 1 } {
	vlog	../src/data_fix/*.v
	vlog	../src/data_fix/change_fifo/*.v
}

##	-------------------------------------------------------------------------------------
##	hispi_if_new 模块
##	-------------------------------------------------------------------------------------
if { $hispi_if_new == 1 } {
	##	-------------------------------------------------------------------------------------
	##	hispi_if_new 模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/data_channel/hispi_if_quick/*.v

	##	-------------------------------------------------------------------------------------
	##	deser 模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/data_channel/deser/*.v

	##	-------------------------------------------------------------------------------------
	##	pll_reset 模块
	##	-------------------------------------------------------------------------------------
	vlog	../src/data_channel/pll_reset.v

}


##	-------------------------------------------------------------------------------------
##	u3v_format 模块
##	-------------------------------------------------------------------------------------
if { $u3v_format == 1 } {
	vlog	../src/u3v_format/*.v
	vlog	../src/u3v_format/adder/*.v
}

##	-------------------------------------------------------------------------------------
##	frame_buffer 模块
##	-------------------------------------------------------------------------------------
if { $frame_buffer == 1 } {
	vlog	../src/frame_buffer/*.v
	vlog	../src/frame_buffer/fifo_w64d256_pf180_pe6/fifo_w64d256_pf180_pe6.v
	vlog	../src/frame_buffer/fifo_w65d1k_pf950_pe6/fifo_w65d1k_pf950_pe6.v
	vlog	../src/frame_buffer/mig_core/ip/mig_core/user_design/rtl/mig_core.v
	vlog	../src/frame_buffer/mig_core/ip/mig_core/user_design/rtl/memc_wrapper.v
	vlog	../src/frame_buffer/mig_core/ip/mig_core/user_design/rtl/mcb_controller/*.v
}

##	-------------------------------------------------------------------------------------
##	u3_interface 模块
##	-------------------------------------------------------------------------------------
if { $u3_interface == 1 } {
	vlog	../src/u3_interface/*.v
	vlog	../src/u3_interface/u3_transfer/*.v
	vlog	../src/u3_interface/u3_transfer/urb_mult/urb_mult.v
}

##	-------------------------------------------------------------------------------------
##	top 模块
##	-------------------------------------------------------------------------------------
if { $top == 1 } {
	vlog	../src/*.v
}


##	-------------------------------------------------------------------------------------
##	编译后仿真生成的时序文件
##	-------------------------------------------------------------------------------------
if {$SIM_MODE == "back" } {
	vlog	"netgen/par/mer_1520_13u3x_timesim.v"
}

##	-------------------------------------------------------------------------------------
##	ref 2.编译仿真模型
##	-------------------------------------------------------------------------------------

##	-------------------------------------------------------------------------------------
##	spi
##	-------------------------------------------------------------------------------------
if {$spi_master == 1 } {
	vlog	+define+TESTCASE=$TESTCASE	../testbench/spi_master/*.v
	vlog	+define+TESTCASE=$TESTCASE	../testbench/spi_master/distri_fifo_w9d32/distri_fifo_w9d32.v
}

##	-------------------------------------------------------------------------------------
##	Sensor hispi 仿真模型
##	-------------------------------------------------------------------------------------
if { $hispi == 1 } {
	vlog	+define+TESTCASE=$TESTCASE	../testbench/hispi/*.v
}

##	-------------------------------------------------------------------------------------
##	ddr3
##	-------------------------------------------------------------------------------------
if { $ddr3 == 1 } {
	vlog	+incdir+../testbench/ddr3_model +define+x1Gb +define+sg15E +define+x16 ../testbench/ddr3_model/ddr3_model_c3.v
	vlog	../testbench/ddr3_model/monitor_ddr3.v
}

##	-------------------------------------------------------------------------------------
##	gpif_3014
##	-------------------------------------------------------------------------------------
if { $gpif_3014 == 1 } {
	vlog	../testbench/gpif_3014/*.v
}


##	-------------------------------------------------------------------------------------
##	ref 3.编译测试代码
##	-------------------------------------------------------------------------------------
vlog	+define+TESTCASE=$TESTCASE	../testbench/tb_$TB_MODULE/*.v

##	-------------------------------------------------------------------------------------
##	ref 4.编译全局测试文件
##	-------------------------------------------------------------------------------------
if { $global_para == 1 } {
	vlog	+define+TESTCASE=$TESTCASE	../testbench/global/*.v
}

